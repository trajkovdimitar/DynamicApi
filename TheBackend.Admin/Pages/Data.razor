@page "/data"
@inject HttpClient Http

<h1 class="h3">Data</h1>

@if (models == null)
{
    <p>Loading...</p>
}
else
{
    <div class="mb-4">
        <label class="form-label">Select Model</label>
        <select class="form-select" value="@selectedModel" @onchange="OnModelChanged">
            <option value="">-- choose --</option>
            @foreach (var m in models)
            {
                <option value="@m.ModelName">@m.ModelName</option>
            }
        </select>
    </div>

    if (selectedDefinition != null && records != null)
    {
        <div class="mb-2">
            <button class="btn btn-primary" @onclick="NewRecord">Add Record</button>
        </div>
        <table class="table table-striped">
            <thead class="table-light">
                <tr>
                    @foreach (var p in selectedDefinition.Properties)
                    {
                        <th class="text-start px-3 py-2 fw-semibold">@p.Name</th>
                    }
                    <th class="px-3 py-2"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in records)
                {
                    <tr>
                        @foreach (var p in selectedDefinition.Properties)
                        {
                            <td class="px-3 py-2">@row[p.Name]</td>
                        }
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-secondary me-2" @onclick="() => EditRecord(row)">Edit</button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteRecord(row)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (editingRecord != null)
{
    <div class="overlay">
        <div class="modal">
            <h2 class="text-xl font-bold mb-4">@recordTitle</h2>
            <EditForm OnValidSubmit="SaveRecord">
                @foreach (var p in selectedDefinition!.Properties)
                {
                    <div class="mb-3">
                        <label class="form-label">@p.Name</label>
                        <InputText class="form-control"
                                   value="@editingRecord[p.Name]?.ToString()"
                                   @onchange="(e => editingRecord[p.Name] = e.Value?.ToString() ?? string.Empty)" />
                    </div>
                }
                <div class="mt-4 text-end">
                    <button type="submit" class="btn btn-primary me-2">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private List<ModelDefinition>? models;
    private string? selectedModel;
    private ModelDefinition? selectedDefinition;
    private List<Dictionary<string, object>>? records;
    private Dictionary<string, object>? editingRecord;
    private string recordTitle = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        models = await Http.GetFromJsonAsync<List<ModelDefinition>>("api/models");
    }

    private async Task OnModelChanged(ChangeEventArgs e)
    {
        selectedModel = e.Value?.ToString();
        await LoadRecords();
    }

    private async Task LoadRecords()
    {
        if (string.IsNullOrEmpty(selectedModel))
        {
            selectedDefinition = null;
            records = null;
            return;
        }

        selectedDefinition = models!.First(m => m.ModelName == selectedModel);
        var json = await Http.GetStringAsync($"api/{selectedModel}");
        var doc = JsonDocument.Parse(json);
        records = doc.RootElement.EnumerateArray()
            .Select(e => e.EnumerateObject().ToDictionary(p => p.Name, p => (object?)p.Value.ToString() ?? string.Empty))
            .ToList();
    }

    private void NewRecord()
    {
        editingRecord = selectedDefinition!.Properties.ToDictionary(p => p.Name, p => (object?)string.Empty);
        recordTitle = $"Add {selectedModel}";
    }

    private void EditRecord(Dictionary<string, object> row)
    {
        editingRecord = new Dictionary<string, object>(row);
        recordTitle = $"Edit {selectedModel}";
    }

    private void CancelEdit()
    {
        editingRecord = null;
    }

    private async Task SaveRecord()
    {
        if (editingRecord == null || selectedDefinition == null || string.IsNullOrEmpty(selectedModel))
            return;

        var keyProp = selectedDefinition.Properties.FirstOrDefault(p => p.IsKey);
        var json = JsonSerializer.Serialize(editingRecord);
        if (keyProp != null && records!.Any(r => r[keyProp.Name]?.ToString() == editingRecord[keyProp.Name]?.ToString()))
        {
            await Http.PutAsync($"api/{selectedModel}/{editingRecord[keyProp.Name]}", new StringContent(json, Encoding.UTF8, "application/json"));
        }
        else
        {
            await Http.PostAsync($"api/{selectedModel}", new StringContent(json, Encoding.UTF8, "application/json"));
        }

        await LoadRecords();
        editingRecord = null;
    }

    private async Task DeleteRecord(Dictionary<string, object> row)
    {
        if (selectedDefinition == null || string.IsNullOrEmpty(selectedModel))
            return;

        var keyProp = selectedDefinition.Properties.FirstOrDefault(p => p.IsKey);
        if (keyProp == null)
            return;

        await Http.DeleteAsync($"api/{selectedModel}/{row[keyProp.Name]}");
        await LoadRecords();
    }
}
